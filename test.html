<!DOCTYPE html>
<meta charset="utf-8">
<title>test graph</title>
<style>
  .link {
    stroke: gray;
    stroke-width: 1.5px;
  }
path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}
  .node {
    fill: #66CC66;
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/js/d3setup.js"></script>
<script>


// https://api.github.com/repos/caleydo/caleydo/commits?per_page=100
// var baseURL = "https://api.github.com/repos/caleydo/caleydo"// /commits?per_page=100"
// // https://api.github.com/repos/mbostock/d3/commits?per_page=100&sha=adopt

// // to get all the branches
// var branchcall = "https://api.github.com/repos/caleydo/caleydo/branches"


// forms url for retrieving branch commits
var getBranchUrl = function(baseUrl, branchName){
  // e.g., https://api.github.com/repos/mbostock/d3/commits?per_page=100&sha=adopt
  return baseUrl+"/commits?per_page=100&sha="+branchName
}

var getListBranchUrl = function(baseUrl){
  return baseUrl+"/branches"
}

var getRecentCommitUrl = function(baseUrl){
  return baseUrl+"/commits?per_page=100"
}



// var myurls = [
// "/data/branch/commits.genlineup.json",
// "/data/branch/commits.scatterplot.json",
// ]
var myurls = [
"/data/branch/commits.develop.json",
"/data/branch/commits.develop_pickingmanager2.json",
"/data/branch/commits.entourage.json",
"/data/branch/commits.genlineup.json",
"/data/branch/commits.master.json",
"/data/branch/commits.scatterplot.json",
"/data/branch/commits.stable_2.0.1.json",
"/data/branch/commits.stable_2.0.2.json",
"/data/branch/commits.stable_2.01.json",
"/data/branch/commits.stable_2.1.json",
"/data/branch/commits.stable_2.json",
"/data/branch/commits.vislinks.json",
"/data/branch/commits.vislinks2.json",
"/data/branch/commits.webpage_unpublished.json",
"/data/branch/commits.xdata.json",
]

var myurls = ["/data/commits.json"]

// var myurls = ["/data/branch/commits.develop.json",
// "/data/branch/commits.develop_pickingmanager2.json","/data/branch/commits.entourage.json"]









// ////////////////////////////////////////////////////////////////
// dataFetcher(myurls, function(datamap){


//   // somedata = datamap
//   //console.log(datamap);
//   var branches = datamap.keys(); // classes are urls for branches


//   var branchToCat = function(branch){
//     return branches.indexOf(branch)
//   }


//   var getCommitDate = function(c){
//     return Date.parse(c.commit.committer.date)
//   }
//   // sort the nodes
//   var nodeCompare = function(a, b){
//     if (getCommitDate(a) > getCommitDate(b)) return -1
//     if (getCommitDate(a) < getCommitDate(b)) return 1
//     return 0
//   }


//   datamap.forEach(function(key, value){
//     // console.log(key)
//     // console.log(value)
//     var myCommits = value
//     var branchName = key

//     myCommits.sort(nodeCompare)

//     myCommits = myCommits //.splice(myCommits.length/2,myCommits.length-myCommits.length/2)
//     d3.map(myCommits).forEach(function (i, myCommit){
//           myCommit.branchName = branchName
//           myCommit.cat = branchToCat(branchName)
//           myCommit.date = getCommitDate(myCommit)
//           alldates.push(myCommit.date) // todo: use set
//     graph.nodes.push(myCommit)
//     })
//   })

//   graph.nodes.sort(nodeCompare);
//   d3.map(graph.nodes).forEach(function(key, value){
//     value.idx = key
//   })

//   // generate links
//   graph.nodes.forEach(function(target_node, i){

//     d3.map(target_node.parents).forEach(function(i, parentCommit){
//       // get source node

//       var source_node = graph.nodes.filter(function(commit_node){
//         return commit_node.sha == parentCommit.sha
//       })[0]

//       if (source_node) {
//         graph.links.push({"source":source_node, "target": target_node})
//       }
//     })
//   })



//     link = svg.selectAll(".link")
//                   .data(graph.links)
//                   .enter()
//                   .append("line")
//                   .attr("class","link")
//                   .attr("marker-end","url(#end)")


//     // generate svg elements for nodes
//     node = svg.append("svg:g").selectAll(".node")
//                   .data(graph.nodes)
//                   .enter()
//                   .append("g")
//                   .attr("class","node")
//                   .on("mouseover",function(d){
//                     console.log("d"+JSON.stringify(d.branchName))
//                     d3.select(this).data([d.branchName])
//                     .enter().append("text")
//                     .attr("test-anchor", "middle").attr("dy", "3em")
//                     .text(d.branchName)
//                   })
//                   .on("mouseout", function(d){
//                     console.log("d"+JSON.stringify(d.branchName))
//                   });


//  path = svg.append("svg:g").selectAll("path")
//            .data(graph.links)
//            .enter().append("svg:path")
//            .attr("class", function(d) {
//             somedata = d
//             return "link " + d.type; })
//            .attr("class", "link")
//            .attr("marker-end", "url(#end)");



//     // append a graphical element for nodes
//     node.append("circle")
//         .attr("r", 5)

//   force_layout() // necessary.

//   // graph.nodes.forEach(function(target_node,i){
//   //   d3.map()

//   category_color()
//   // force_layout() 
//   // line_cat_layout()

//   // force_layout() 
//   // line_cat_layout()
//   line_cat_layout_time()
//   // line_cat_layout_idx()
// });


///////////



// download all branch info first

// d3.json( getListBranchUrl(baseURL), function(branchdata){

//   console.log("bd"+branchdata)

//   d3.map(branchdata).forEach(function(key,value){
//     var branches = value

//   })
// });
getListBranchUrl(baseURL)


// var baseURL = "https://api.github.com/repos/mbostock/d3"// /commits?per_page=100"


var baseURL = "https://api.github.com/repos/caleydo/caleydo"

"https://api.github.com/repos/mbostock/d3/commits?per_page=100"


// test the app before going live and risking call limit!
var localDictionary = {
"https://api.github.com/repos/caleydo/caleydo/branches": "/data/branches.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100": "/data/commits.json",
// "https://api.github.com/repos/caleydo/caleydo/commits?per_page=100": "/data/branch/commits.genlineup.json",

"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=develop":"/data/branch/commits.develop.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=develop_pickingmanager2":"/data/branch/commits.develop_pickingmanager2.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=entourage":"/data/branch/commits.entourage.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=genlineup":"/data/branch/commits.genlineup.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=master":"/data/branch/commits.master.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=scatterplot":"/data/branch/commits.scatterplot.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=stable_2.0.1":"/data/branch/commits.stable_2.0.1.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=stable_2.0.2":"/data/branch/commits.stable_2.0.2.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=stable_2.01":"/data/branch/commits.stable_2.01.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=stable_2.1":"/data/branch/commits.stable_2.1.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=stable_2":"/data/branch/commits.stable_2.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=vislinks":"/data/branch/commits.vislinks.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=vislinks2":"/data/branch/commits.vislinks2.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=webpage_unpublished":"/data/branch/commits.webpage_unpublished.json",
"https://api.github.com/repos/caleydo/caleydo/commits?per_page=100&sha=xdata":"/data/branch/commits.xdata.json",
}

var d3JsonWrapper = function(url, callbackfunction){
  d3.json( localDictionary[url], callbackfunction );
}
// https://github.com/mbostock/d3
// retrieve all branch information first
d3JsonWrapper( getListBranchUrl(baseURL), function(branchdata){
  // then retrieve recent commits
  d3JsonWrapper( getRecentCommitUrl(baseURL), function(commitdata){
    somedata = commitdata
    // find all relevant branches for the recent commits
    var commits_sha = commitdata.map(function(x){
      return x.sha;
    });

    
    console.log(commits_sha)

    var relevant_branch = branchdata.filter(function(branch){
          console.log(branch);
          // return true;
         return commits_sha.indexOf(branch.commit.sha) >= 0;
    });



    // somedata = relevant_branch
    console.log("r"+JSON.stringify(relevant_branch))

  });
});






// Date.parse("2014-02-21T21:01:40Z")
// 1393016500000
// Date.parse("2014-02-25T13:16:55Z")
// 1393334215000






// Date.parse("2014-02-25T13:16:55Z")
// Date.parse("2014-02-21T21:01:40Z")

























</script>
</body>