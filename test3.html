<!DOCTYPE html>
<meta charset="utf-8">
<title>test graph</title>
<style>
  .link {
    stroke: gray;
    stroke-width: 1.5px;
  }
path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}
  .node {
    fill: #66CC66;
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>

<form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="random" > Random</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>  
    <label><input type="radio" name="layout" value="line"> Line</label>
    <label><input type="radio" name="layout" value="line_cat"> Line by Category</label>
    
  </form>

  <form>
  X-axis:
  <label><input type="radio" name="xaxis" value="line_idx"> x-Axis by index</label>
  <label><input type="radio" name="xaxis" value="line_time"> x-Axis by time</label>
  </form>
  <form>
  Color:
    <label><input type="radio" name="color" value="nocolor" checked> None</label>
    <label><input type="radio" name="color" value="color_cat" > Category</label>
  </form>
  <form>
  Size:
    <label><input type="radio" name="size" value="nosize" checked> None</label>
    <label><input type="radio" name="size" value="size_cat" > Category</label>
  </form>


<script src="/js/d3setup.js"></script>
<script>


// https://api.github.com/repos/caleydo/caleydo/commits?per_page=100
// var baseURL = "https://api.github.com/repos/caleydo/caleydo"// /commits?per_page=100"
// // https://api.github.com/repos/mbostock/d3/commits?per_page=100&sha=adopt

// // to get all the branches
// var branchcall = "https://api.github.com/repos/caleydo/caleydo/branches"
//https://api.github.com/repos/mbostock/d3/commits?access_token=de2be790b564a799155c96e311884854e4e65be9



var project = "caleydo/caleydo"
// var project = "mbostock/d3"

var baseURL = "https://api.github.com/repos/"+project //caleydo/caleydo"

/// REMEMBER TO BLANK THIS BEFORE SUBMISSION! //////////////////////////////////////////////////////
var token = "access_token=de2be790b564a799155c96e311884854e4e65be9"

// forms url for retrieving branch commits
var getBranchUrl = function(baseUrl, branchName){
  // e.g., https://api.github.com/repos/mbostock/d3/commits?per_page=100&sha=adopt
  return baseUrl+"/commits?"+token+"&per_page=50&sha="+branchName
}

var getListBranchUrl = function(baseUrl){
  return baseUrl+"/branches?"+token
}

var getRecentCommitUrl = function(baseUrl){
  return baseUrl+"/commits?"+token+"&per_page=100"
}


// branches to explore in caleydo
var branches = [
// "entourage",
"develop_genlineup",
"scatterplot",
// "xdata"
]


//generate urls to explore
var myurls = []


d3.map(branches).forEach(function(k,branch){
  myurls.push(getBranchUrl(baseURL,branch));
});








////////////////////////////////////////////////////////////////
// var xfunc = function() {
  dataFetcher(myurls, function(datamap){
    // somedata = datamap
    console.log(datamap);
    var branches = datamap.keys(); // classes are urls for branches


    var branchToCat = function(branch){
      return branches.indexOf(branch)
    }


    var getCommitDate = function(c){
      return Date.parse(c.commit.committer.date)
    }
    // sort the nodes
    var nodeCompare = function(a, b){
      if (getCommitDate(a) > getCommitDate(b)) return -1
      if (getCommitDate(a) < getCommitDate(b)) return 1
      return 0
    }


    datamap.forEach(function(key, value){
      // console.log(key)
      // console.log(value)
      var myCommits = value
      var branchName = key

      myCommits.sort(nodeCompare)

      // myCommits = myCommits.splice(myCommits.length/2,myCommits.length-myCommits.length/2)
      d3.map(myCommits).forEach(function (i, myCommit){
            myCommit.branchName = branchName
            myCommit.cat = branchToCat(branchName)
            myCommit.date = getCommitDate(myCommit)
            alldates.push(myCommit.date) // todo: use set
      graph.nodes.push(myCommit)
      })
    })

    graph.nodes.sort(nodeCompare);
    d3.map(graph.nodes).forEach(function(key, value){
      value.idx = key
    })

    // generate links
    graph.nodes.forEach(function(target_node, i){

      d3.map(target_node.parents).forEach(function(i, parentCommit){
        // get source node

        var source_node = graph.nodes.filter(function(commit_node){
          return commit_node.sha == parentCommit.sha
        })[0]

        if (source_node) {
          graph.links.push({"source":source_node, "target": target_node})
        }
      })
    })



      link = svg.selectAll(".link")
                    .data(graph.links)
                    .enter()
                    .append("line")
                    .attr("class","link")
                    .attr("marker-end","url(#end)")


      // generate svg elements for nodes
      node = svg.append("svg:g").selectAll(".node")
                    .data(graph.nodes)
                    .enter()
                    .append("g")
                    .attr("class","node")
                    .on("mouseover",function(d){
                      console.log("d"+JSON.stringify(d.branchName))
                      d3.select(this).data([d.branchName])
                      .enter().append("text")
                      .attr("test-anchor", "middle").attr("dy", "3em")
                      .text(d.branchName)
                    })
                    .on("mouseout", function(d){
                      console.log("d"+JSON.stringify(d.branchName))
                    });


   path = svg.append("svg:g").selectAll("path")
             .data(graph.links)
             .enter().append("svg:path")
             .attr("class", function(d) {
              somedata = d
              return "link " + d.type; })
             .attr("class", "link")
             .attr("marker-end", "url(#end)");



      // append a graphical element for nodes
      node.append("circle")
          .attr("r", 5)

    force_layout() // necessary.

    // graph.nodes.forEach(function(target_node,i){
    //   d3.map()

    category_color()
    // force_layout() 
    // line_cat_layout()

    // force_layout() 
    // line_cat_layout()
    // line_cat_layout_time()
    line_cat_layout_idx()
  });
// };


////////////////////////////////////////////////////////////////////////////

// var inArray = function(myArray, x){
//   return (myArray.indexOf(x) >= 0)
// }

// // var project = "caleydo/caleydo"
// var project = "mbostock/d3"

// var baseURL = "https://api.github.com/repos/"+project //caleydo/caleydo"

// var d3JsonWrapper = function(url, callbackfunction){

//   d3.json( url, callbackfunction );
// }

// // https://github.com/mbostock/d3
// // retrieve all branch information first
// d3JsonWrapper( getListBranchUrl(baseURL), function(branchdata){
//   // then retrieve recent commits
//   d3JsonWrapper( getRecentCommitUrl(baseURL), function(commitdata){
//     somedata = commitdata
//     // find all relevant branches for the recent commits
//     var commits_sha = commitdata.map(function(x){
//       return x.sha;
//     });

//     console.log(commits_sha)

//     var notInMain = []


//     // collect parent nodes
//     // var commits_sha_parents = []
//     d3.map(commitdata).forEach(function(k,v){

//       d3.map(v.parents).forEach(function(k,parent){
//         // if (inArray(commits_sha, parent.sha)) {
//         //   console.log("found one"+parent.sha)
//         // }
//         commits_sha.push(parent.sha)
//       });
//     });



//     var relevant_branch = branchdata.filter(function(branch){
//           console.log(branch);
//           // return true;
//          return commits_sha.indexOf(branch.commit.sha) >= 0;
//     });

//     somedata = relevant_branch
//     console.log("r"+JSON.stringify(relevant_branch))

//     // console.log(commits_sha)
//     // console.log(commits_sha_parents)
//   });
// });








d3.select("input[value=\"line_idx\"]").on("click", line_cat_layout_idx);
d3.select("input[value=\"line_time\"]").on("click", line_cat_layout_time);







</script>
</body>